
using Graphs
using SparseArrays
using LinearAlgebra
using KrylovKit
using Random
using Plots

println("=== HW7 Task 2: Spectral Gap Analysis ===")

"""
    idx(row, col) -> vertex index
Map (row, col) -> vertex index for 2-row lattice graphs.
"""
idx(row, col) = 2*(col-1) + row   # row = 1 or 2

"""
    triangles_graph(N)
2×L ladder with diagonals forming triangles.
N must be even and N = 2L.
"""
function triangles_graph(N::Int)
    @assert iseven(N) "N must be even for triangles_graph"
    L = N ÷ 2
    g = SimpleGraph(N)

    # horizontal edges
    for c in 1:L-1
        add_edge!(g, idx(1,c), idx(1,c+1))
        add_edge!(g, idx(2,c), idx(2,c+1))
    end
    # vertical edges
    for c in 1:L
        add_edge!(g, idx(1,c), idx(2,c))
    end
    # one diagonal per square (from top-left to bottom-right)
    for c in 1:L-1
        add_edge!(g, idx(1,c), idx(2,c+1))
    end
    return g
end

"""
    squares_graph(N)
2×L ladder of squares (no diagonals).
N must be even and N = 2L.
"""
function squares_graph(N::Int)
    @assert iseven(N) "N must be even for squares_graph"
    L = N ÷ 2
    g = SimpleGraph(N)

    # horizontal edges
    for c in 1:L-1
        add_edge!(g, idx(1,c), idx(1,c+1))
        add_edge!(g, idx(2,c), idx(2,c+1))
    end
    # vertical edges
    for c in 1:L
        add_edge!(g, idx(1,c), idx(2,c))
    end
    return g
end

"""
    diamonds_graph(N)
2×L ladder with both diagonals forming diamonds.
N must be even and N = 2L.
"""
function diamonds_graph(N::Int)
    @assert iseven(N) "N must be even for diamonds_graph"
    L = N ÷ 2
    g = SimpleGraph(N)

    # horizontal edges
    for c in 1:L-1
        add_edge!(g, idx(1,c), idx(1,c+1))
        add_edge!(g, idx(2,c), idx(2,c+1))
    end
    # vertical edges
    for c in 1:L
        add_edge!(g, idx(1,c), idx(2,c))
    end
    # both diagonals per cell
    for c in 1:L-1
        add_edge!(g, idx(1,c), idx(2,c+1))
        add_edge!(g, idx(2,c), idx(1,c+1))
    end
    return g
end

"""
    spin_of_state(s::Int, i::Int) -> ±1
Get spin at site i from integer label s (0-based), bits 0..N-1.
"""
@inline spin_of_state(s::Int, i::Int) = ((s >> (i-1)) & 1) == 1 ? 1 : -1

"""
    build_transition_matrix(g, T)
Construct sparse Metropolis transition matrix P(T) for
single-spin flip dynamics on graph g at temperature T.
State space: all σ ∈ {±1}^N, encoded as integers 0..2^N-1.
"""
function build_transition_matrix(g::SimpleGraph, T::Float64)
    N = nv(g)
    nstates = 1 << N
    β = 1.0 / T

    # pre-build neighbor list (1-based vertex indices)
    neigh = [collect(neighbors(g, v)) for v in 1:N]

    # we'll collect I, J, V for sparse(I,J,V,nstates,nstates)
    row_idx = Int[]
    col_idx = Int[]
    vals    = Float64[]

    # loop over all configurations (encoded as 0..2^N-1)
    for s in 0:nstates-1
        row = s + 1
        outgoing = 0.0

        # try flipping each spin
        for i in 1:N
            si = spin_of_state(s, i)
            # local field at i: sum_{j~i} σ_j
            h = 0
            for j in neigh[i]
                h += spin_of_state(s, j)
            end
            ΔE = 2.0 * si * h        # J=1, anti-ferro H = Σ σ_i σ_j
            # Metropolis acceptance prob
            a = ΔE <= 0 ? 1.0 : exp(-β * ΔE)
            p = (1.0 / N) * a
            outgoing += p

            # index of flipped state
            sflipped = s ⊻ (1 << (i-1))    # xor the bit i-1
            col = sflipped + 1

            push!(row_idx, row)
            push!(col_idx, col)
            push!(vals, p)
        end

        # self-loop probability
        push!(row_idx, row)
        push!(col_idx, row)
        push!(vals, 1.0 - outgoing)
    end

    P = sparse(row_idx, col_idx, vals, nstates, nstates)
    return P
end

"""
    spectral_gap(g, T; nev=2)
Compute spectral gap γ(T) = 1 - λ₂ for Metropolis chain on g at temperature T.
Uses KrylovKit to find the top two eigenvalues of P(T).
"""
function spectral_gap(g::SimpleGraph, T::Float64)
    P = build_transition_matrix(g, T)

    # largest-magnitude eigenvalues
    vals, _, _ = eigsolve(P, 2, :LM; tol=1e-8, maxiter=500)
    # sort so λ1 ≈ 1, λ2 ≤ λ1
    λ = sort(real.(vals), rev=true)
    λ1, λ2 = λ[1], λ[2]
    return 1.0 - λ2, λ1, λ2
end

"""
Task 1: Analyze spectral gap vs. temperature
"""
function analyze_gap_vs_temperature()
    println("\n--- Task 1: Spectral Gap vs. Temperature ---")

    N = 18
    g_tri = triangles_graph(N)
    g_sq = squares_graph(N)
    g_dia = diamonds_graph(N)

    Ts = 0.1:0.1:2.0

    println("\nProcessing triangles graph...")
    gaps_tri = Float64[]
    for T in Ts
        gap, λ1, λ2 = spectral_gap(g_tri, T)
        push!(gaps_tri, gap)
        println("T = $(round(T, digits=2)), gap = $(round(gap, digits=5))")
    end

    println("\nProcessing squares graph...")
    gaps_sq = Float64[]
    for T in Ts
        gap, λ1, λ2 = spectral_gap(g_sq, T)
        push!(gaps_sq, gap)
        println("T = $(round(T, digits=2)), gap = $(round(gap, digits=5))")
    end

    println("\nProcessing diamonds graph...")
    gaps_dia = Float64[]
    for T in Ts
        gap, λ1, λ2 = spectral_gap(g_dia, T)
        push!(gaps_dia, gap)
        println("T = $(round(T, digits=2)), gap = $(round(gap, digits=5))")
    end

    # Create plot
    p = plot(
        title="Spectral Gap vs. Temperature (N=18)",
        xlabel="Temperature T",
        ylabel="Spectral Gap",
        legend=:topright,
        size=(800, 600)
    )

    plot!(p, Ts, gaps_tri, label="Triangles", marker=:circle, linewidth=2)
    plot!(p, Ts, gaps_sq, label="Squares", marker=:square, linewidth=2)
    plot!(p, Ts, gaps_dia, label="Diamonds", marker=:diamond, linewidth=2)

    savefig(p, "gap_vs_temperature.png")
    println("✅ Plot saved: gap_vs_temperature.png")

    return Ts, gaps_tri, gaps_sq, gaps_dia
end

"""
Task 2: Analyze spectral gap vs. system size at T = 0.1
"""
function analyze_gap_vs_size()
    println("\n--- Task 2: Spectral Gap vs. System Size ---")

    Tfixed = 0.1

    println("\nProcessing triangles graphs...")
    sizes = 4:2:18  # even sizes
    gaps_tri = Float64[]
    for N in sizes
        g = triangles_graph(N)
        gap, _, _ = spectral_gap(g, Tfixed)
        push!(gaps_tri, gap)
        println("N = $N, gap = $(round(gap, digits=5))")
    end

    println("\nProcessing squares graphs...")
    gaps_sq = Float64[]
    for N in sizes
        g = squares_graph(N)
        gap, _, _ = spectral_gap(g, Tfixed)
        push!(gaps_sq, gap)
        println("N = $N, gap = $(round(gap, digits=5))")
    end

    println("\nProcessing diamonds graphs...")
    gaps_dia = Float64[]
    for N in sizes
        g = diamonds_graph(N)
        gap, _, _ = spectral_gap(g, Tfixed)
        push!(gaps_dia, gap)
        println("N = $N, gap = $(round(gap, digits=5))")
    end

    # Create plot
    p = plot(
        title="Spectral Gap vs. System Size (T = 0.1)",
        xlabel="System Size N",
        ylabel="Spectral Gap",
        legend=:topright,
        size=(800, 600)
    )

    plot!(p, sizes, gaps_tri, label="Triangles", marker=:circle, linewidth=2)
    plot!(p, sizes, gaps_sq, label="Squares", marker=:square, linewidth=2)
    plot!(p, sizes, gaps_dia, label="Diamonds", marker=:diamond, linewidth=2)

    savefig(p, "gap_vs_size.png")
    println("✅ Plot saved: gap_vs_size.png")

    return sizes, gaps_tri, gaps_sq, gaps_dia
end

"""
Solve Problem 2: Spectral gap analysis
"""
function solve_problem2()
    println("\n" * "=" ^ 70)
    println("PROBLEM 2: Spectral Gap Analysis")
    println("=" ^ 70)

    # Task 1: Spectral gap vs temperature
    Ts, gaps_tri_T, gaps_sq_T, gaps_dia_T = analyze_gap_vs_temperature()

    # Task 2: Spectral gap vs system size
    sizes, gaps_tri_N, gaps_sq_N, gaps_dia_N = analyze_gap_vs_size()

    println("\n✅ Problem 2 completed!")
    println("Analysis of spectral gaps for triangles, squares, and diamonds graphs completed.")
    println("Results saved in gap_vs_temperature.png and gap_vs_size.png")

    return (Ts, gaps_tri_T, gaps_sq_T, gaps_dia_T), (sizes, gaps_tri_N, gaps_sq_N, gaps_dia_N)
end

println("Starting Task 2...")
temp_results, size_results = solve_problem2()

println("\nTask 2 completed successfully!")
println("The spectral gap analysis for different graph topologies has been completed.")