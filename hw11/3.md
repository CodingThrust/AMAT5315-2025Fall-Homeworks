using ForwardDiff
using CairoMakie

# Given data
time_data = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
population_data = [10, 15, 25, 40, 60, 80, 95, 105, 110, 112, 113]

# Logistic growth model
logistic_model(t, K, r, t0) = K / (1 + exp(-r * (t - t0)))

# Loss function (Mean Squared Error)
function mse_loss(params)
    K, r, t0 = params
    predicted = [logistic_model(t, K, r, t0) for t in time_data]
    errors = predicted - population_data
    return sum(errors.^2) / length(errors)
end

# Adam optimizer implementation
function adam_optimize(loss_func, initial_params; 
    learning_rate=0.05, 
    beta1=0.9, 
    beta2=0.999, 
    epsilon=1e-8, 
    iterations=2000)
    
    params = copy(initial_params)
    m = zeros(length(params))
    v = zeros(length(params))
    losses = Float64[]
    
    for t in 1:iterations
        gradient = ForwardDiff.gradient(loss_func, params)
        
        m = beta1 * m + (1 - beta1) * gradient
        v = beta2 * v + (1 - beta2) * gradient.^2
        
        m_hat = m / (1 - beta1^t)
        v_hat = v / (1 - beta2^t)
        
        params = params - learning_rate * m_hat / (sqrt.(v_hat) + epsilon)
        
        # Apply parameter constraints
        params[1] = max(1.0, params[1])  # K > 0
        params[2] = max(0.01, params[2])  # r > 0
        params[3] = max(-5.0, min(15.0, params[3]))  # reasonable t0 range
        
        push!(losses, loss_func(params))
    end
    
    return params, losses
end

# Initial parameters
initial_parameters = [120.0, 0.5, 5.0]

# Fit the model
fitted_params, training_losses = adam_optimize(mse_loss, initial_parameters)
K_fitted, r_fitted, t0_fitted = fitted_params

println("Fitted Parameters:")
println("K (carrying capacity) = $(round(K_fitted, digits=4))")
println("r (growth rate) = $(round(r_fitted, digits=4))")
println("t0 (inflection point) = $(round(t0_fitted, digits=4))")
println("Final MSE = $(round(training_losses[end], digits=6))")

# Visualization
figure = Figure(resolution=(1000, 400))

# Plot 1: Data vs fitted curve
axis1 = Axis(figure[1, 1],
    xlabel="Time",
    ylabel="Population",
    title="Logistic Growth Model Fit"
)
scatter!(axis1, time_data, population_data, label="Observed Data", markersize=8)
time_smooth = range(0, 10, length=200)
fitted_curve = [logistic_model(t, K_fitted, r_fitted, t0_fitted) for t in time_smooth]
lines!(axis1, time_smooth, fitted_curve, label="Fitted Curve", linewidth=2)
axislegend(axis1)

# Plot 2: Convergence
axis2 = Axis(figure[1, 2],
    xlabel="Iteration",
    ylabel="MSE (log scale)",
    title="Training Convergence"
)
lines!(axis2, 1:length(training_losses), training_losses, linewidth=2)
ylims!(axis2, minimum(training_losses) * 0.1, maximum(training_losses))

figure